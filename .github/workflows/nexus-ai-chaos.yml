name: NEXUS_AI_CHAOS_PIPELINE

on:
  workflow_dispatch:
    inputs:
      topic:
        description: Content topic for video generation
        required: true
        type: string
      platform:
        description: Target platform
        required: true
        type: choice
        options:
          - youtube_shorts
          - instagram_reels
          - x_video
      duration_seconds:
        description: Video duration (max 60)
        required: true
        type: number
      tone:
        description: Content tone
        required: true
        type: choice
        options:
          - dark
          - cinematic
          - educational
          - hype
      visual_style:
        description: Visual aesthetic
        required: true
        type: choice
        options:
          - cyberpunk
          - cinematic
          - realistic
      cta_required:
        description: Include call-to-action
        required: false
        type: boolean
        default: false
  schedule:
    - cron: '0 6 * * *'

jobs:
  nexus_pipeline:
    runs-on: ubuntu-latest
    env:
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      GROK_API_KEY: ${{ secrets.GROK_API_KEY }}
      TTS_API_KEY: ${{ secrets.TTS_API_KEY }}
      FFMPEG_ENABLED: ${{ secrets.FFMPEG_ENABLED }}
      PIPELINE_RUN_ID: ${{ github.run_id }}
      TOPIC: ${{ github.event.inputs.topic }}
      PLATFORM: ${{ github.event.inputs.platform }}
      DURATION_SECONDS: ${{ github.event.inputs.duration_seconds }}
      TONE: ${{ github.event.inputs.tone }}
      VISUAL_STYLE: ${{ github.event.inputs.visual_style }}
      CTA_REQUIRED: ${{ github.event.inputs.cta_required }}
    steps:
      - name: Validate Input Schema
        run: |
          echo "Validating input payload..."
          echo "Topic: ${TOPIC}"
          echo "Platform: ${PLATFORM}"
          echo "Duration: ${DURATION_SECONDS}s (max 60)"
          echo "Tone: ${TONE}"
          echo "Visual Style: ${VISUAL_STYLE}"
          echo "CTA Required: ${CTA_REQUIRED}"
          
          if [ ${DURATION_SECONDS} -gt 60 ]; then
            echo "ERROR: Duration exceeds 60 seconds"
            exit 1
          fi
          
          if [ -z "${TOPIC}" ]; then
            echo "ERROR: Topic is required"
            exit 1
          fi
          
          echo "Input validation successful"

      - name: Generate Video Script (ChatGPT)
        run: |
          echo "Starting ChatGPT script generation..."
          echo "Using OPENAI_API_KEY from secrets (reference only, value hidden)"
          echo "Input: topic=${TOPIC}, tone=${TONE}, duration=${DURATION_SECONDS}s"
          
          cat > /tmp/script_request.json <<'EOF'
          {
            "topic": "${TOPIC}",
            "tone": "${TONE}",
            "duration_seconds": ${DURATION_SECONDS},
            "cta_required": ${CTA_REQUIRED}
          }
          EOF
          
          echo "Script request payload prepared (see PIPELINE_ARCHITECTURE.md for schema)"
          echo "Next: ChatGPT will generate script with scene breakdown"
          echo "Expected output: script + scenes array with visual_description, camera_motion, mood, on_screen_text"
          echo "Constraint: Each scene 2-4 seconds, hook within 2 seconds"
          
      - name: Generate Visual Prompt (Grok Imagine)
        run: |
          echo "Starting Grok Imagine visual generation..."
          echo "Using GROK_API_KEY from secrets (reference only, value hidden)"
          echo "Input: visual_style=${VISUAL_STYLE}, tone=${TONE}"
          
          cat > /tmp/visual_prompt.txt <<'EOF'
          Cinematic vertical video (9:16), dark cyberpunk aesthetic.
          Topic: ${TOPIC}
          Visual Style: ${VISUAL_STYLE}
          Tone: ${TONE}
          Color palette: dark reds, deep blues, blacks.
          Vibe: authoritative, technical, unsettling.
          No playful elements. Emphasis on technological innovation/threat.
          First 1.5 seconds weighted for hook impact.
          EOF
          
          echo "Unified visual prompt prepared"
          echo "Next: Grok Imagine will generate single 9:16 cinematic image"
          
      - name: Validate Output Contracts
        run: |
          echo "Validating output contract structure..."
          
          cat > /tmp/output_contract.json <<'EOF'
          {
            "pipeline_run_id": "${PIPELINE_RUN_ID}",
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "input": {
              "topic": "${TOPIC}",
              "platform": "${PLATFORM}",
              "duration_seconds": ${DURATION_SECONDS},
              "tone": "${TONE}",
              "visual_style": "${VISUAL_STYLE}",
              "cta_required": ${CTA_REQUIRED}
            },
            "status": "in_progress"
          }
          EOF
          
          echo "Output contract initialized (see PIPELINE_ARCHITECTURE.md for full schema)"
          
      - name: Post-Processing (Conditional)
        run: |
          echo "Post-processing configuration..."
          echo "FFMPEG_ENABLED: ${FFMPEG_ENABLED}"
          
          if [ "${FFMPEG_ENABLED}" = "true" ]; then
            echo "FFmpeg post-processing enabled"
            echo "Steps:"
            echo "  1. Aspect ratio enforcement (9:16 vertical)"
            echo "  2. Caption overlay generation (on_screen_text from scenes)"
            echo "  3. Duration trimming (max 60 seconds)"
            echo "  4. Audio synthesis (script -> TTS using TTS_API_KEY)"
            echo "  5. Watermark/branding application"
            echo "  6. Format conversion (MP4/WebM)"
          else
            echo "FFmpeg post-processing disabled"
          fi
          
      - name: Package Output Artifacts
        run: |
          echo "Packaging output artifacts..."
          echo "Expected outputs:"
          echo "  - video_master.mp4 (source master)"
          echo "  - video_youtube_shorts.mp4 (platform-optimized, 9:16)"
          echo "  - video_instagram_reels.mp4 (platform-optimized, 9:16)"
          echo "  - video_x_video.mp4 (platform-optimized, 9:16)"
          echo "  - metadata.json (title, description, tags, hook_timestamp_ms)"
          
          echo "Artifact naming convention: deterministic (run_id + platform)"
          echo "All artifacts adhere to brand identity rules (no emojis, no hashtags)"
          
      - name: Final Validation & Status Report
        run: |
          echo "Pipeline execution complete"
          echo "Run ID: ${PIPELINE_RUN_ID}"
          echo "Platform: ${PLATFORM}"
          echo "Topic: ${TOPIC}"
          echo "Tone: ${TONE}"
          echo "Visual Style: ${VISUAL_STYLE}"
          echo "Status: SUCCESS (dry run validation)"
